local function IsPlayerESPVisible(plr, character)
    -- Reset debug flag each frame so it only prints once
    local printed = false

    local function debug(reason)
        if not printed then
            printed = true
            warn("[ESP DEBUG] " .. plr.Name .. " skipped: " .. reason)
        end
    end

    -- Missing character
    if not character then
        debug("No character")
        return false
    end

    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then
        debug("No HumanoidRootPart")
        return false
    end

    -- Alive check
    local aliveFlag = plr:FindFirstChild("PlayerStates") 
                       and plr.PlayerStates:FindFirstChild("Alive")
    if aliveFlag and aliveFlag.Value ~= true then
        debug("Alive.Value == false")
        return false
    end

    -- Killer flag (your gameâ€™s death detection)
    if character:FindFirstChild("Killer") then
        debug("Has Killer (dead)")
        return false
    end

    -- Team check (normal mode)
    if not FriendMode then
        if plr.PlayerStates.Team.Value == LocalPlayer.PlayerStates.Team.Value then
            debug("Same team as LocalPlayer")
            return false
        end
    end

    -- FriendMode check: use friend's team instead of localplayer
    if FriendMode and FriendPlayer then
        if plr.PlayerStates.Team.Value == FriendPlayer.PlayerStates.Team.Value then
            debug("Same team as FriendPlayer (FriendMode)")
            return false
        end
    end

    -- LocalPlayer exclusion
    if plr == LocalPlayer then
        debug("Is LocalPlayer (skipped)")
        return false
    end

    -- Check if on screen
    local pos, onscreen = Camera:WorldToViewportPoint(hrp.Position)
    if not onscreen then
        debug("Off-screen")
        return false
    end

    -- Distance check
    if (hrp.Position - Camera.CFrame.Position).Magnitude > 1000 then
        debug("Too far")
        return false
    end

    return true
end
